# Use the rust image as the base image for the build stage
FROM rust:latest AS builder

# Copy the Rust-TEOS source code
COPY . /tmp/rust-teos

# Install the dependencies required for building Rust-TEOSd
RUN apt-get update && \
    apt-get -y --no-install-recommends install libffi-dev libssl-dev musl-tools pkg-config

RUN cd /tmp/rust-teos \
    && rustup target add x86_64-unknown-linux-musl \
    # Rustfmt is needed to format the grpc stubs generated by tonic.
    && rustup component add rustfmt \
    # Cross compile with musl as the target, so teos can run on alpine.
    && cargo build --manifest-path=teos/Cargo.toml --locked --release --target x86_64-unknown-linux-musl

# Use a new stage with a smaller base image to reduce image size
FROM alpine:latest

RUN apk update && apk upgrade && apk add --update bash sudo

# Copy the teos binary from the build stage to the new stage
COPY --from=builder \
    /tmp/rust-teos/target/x86_64-unknown-linux-musl/release/teosd \
    /tmp/rust-teos/target/x86_64-unknown-linux-musl/release/teos-cli /usr/local/bin/

# Copy the entrypoint script to the container
COPY docker/entrypoint.sh /entrypoint.sh

# Set the entrypoint script as executable
RUN chmod +x /entrypoint.sh

# Add a new user (with sudo permisions)
RUN adduser -S teos
RUN echo 'teos ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers

# Expose the default port used by Rust-TEOSd
EXPOSE 9814/tcp

# Create a volume for the TEOS data directory
RUN mkdir /home/teos/.teos
RUN chown teos /home/teos/.teos

# Switch user so that we don't run stuff as root
USER teos

# Start Rust-TEOS when the container starts
ENTRYPOINT [ "/entrypoint.sh" ]
